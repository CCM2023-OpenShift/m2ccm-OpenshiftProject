flowchart LR
%% PostgreSQL
  subgraph "DÃ©ployer PostgreSQL (infrastructure/postgresql-deployment.yaml)"
    A2["â¬‡ï¸ Installer la CLI oc"] --> A3["ðŸ” Se connecter Ã  OpenShift"]
    A3 --> A4["ðŸš€ Appliquer le YAML PostgreSQL"]
  end

%% Quarkus
  subgraph "Build & DÃ©ploiement Quarkus (src/**)"
    B2["â˜• Configurer JDK 21"] --> B3["ðŸ·ï¸ GÃ©nÃ©rer un tag dâ€™image unique"]
    B3 --> B4["ðŸ“¦ Construire lâ€™application (.jar)"]
    B4 --> B5["â¬‡ï¸ Installer la CLI oc"]
    B5 --> B6["ðŸ” Se connecter Ã  OpenShift"]
    B6 --> B7["ðŸ› ï¸ Configurer BuildConfig & ImageStream"]
    B7 --> B8["âš™ï¸ Ajuster les ressources de build"]
    B8 --> B9["ðŸ§¹ Nettoyer les builds Ã©chouÃ©s"]
    B9 --> B10["ðŸ³ Lancer le build sur le cluster (oc start-build)"]
    B10 --> B11["ðŸ“„ Appliquer le YAML de dÃ©ploiement"]
    B11 --> B12["ðŸ”„ DÃ©ployer avec le tag unique"]
    B12 --> B13["ðŸŒ Afficher lâ€™URL de lâ€™API"]
  end
  B10 -->|dÃ©pend de| B12

%% Frontend
  subgraph "DÃ©ployer le front (front/**)"
    C2["â¬‡ï¸ Installer la CLI oc"] --> C3["ðŸ” Se connecter Ã  OpenShift"]
    C3 --> C4["ðŸš€ DÃ©ployer ou mettre Ã  jour vite-oc"]
    C4 --> C5["ðŸŒ Exposer la Route"]
    C5 --> C6["ðŸ”’ Ajouter TLS"]
    C6 --> C7["ðŸ“‘ Appliquer le YAML de Route"]
    C7 --> C8["âœ… VÃ©rifier le dÃ©ploiement & la Route"]
  end

%% Keycloak
  subgraph "DÃ©ployer Keycloak (infrastructure/keycloak/**)"
    D2["â¬‡ï¸ Installer la CLI oc"] --> D3["ðŸ” Se connecter Ã  OpenShift"]
    D3 --> D4["ðŸš€ DÃ©ployer PostgreSQL pour Keycloak"]
    D4 --> D5["ðŸš€ DÃ©ployer le serveur Keycloak"]
    D5 --> D6["ðŸ” RedÃ©marrer Keycloak si besoin"]
    D6 --> D7["ðŸ“œ Appliquer la config de realm"]
    D7 --> D8["âŒ› Attendre que Keycloak soit prÃªt"]
    D8 --> D9["ðŸŒ RÃ©cupÃ©rer lâ€™URL de Keycloak"]
  end

%% Network Policies
  subgraph "Appliquer les Network Policies (infrastructure/networkpolicies.yaml)"
    E2["â¬‡ï¸ Installer la CLI oc"] --> E3["ðŸ” Se connecter Ã  OpenShift"]
    E3 --> E4["ðŸš¦ Appliquer le YAML des Network Policies"]
    E4 --> E5["ðŸ” VÃ©rifier les Network Policies"]
    E5 --> E6["ðŸ“ DÃ©crire isolate-postgresql"]
  end

%% CI Back uniquement
  subgraph "CI Back (src/**)"
    F2["â˜• Configurer JDK 21"] --> F3["ðŸ“¦ Construire lâ€™application (local)"]
  end

%% Build React
  subgraph "Build de lâ€™application React (front/**)"
    G2["â¬‡ï¸ Installer la CLI oc"] --> G3["ðŸ” Se connecter Ã  OpenShift"]
    G3 --> G4["ðŸ› ï¸ CrÃ©er .env.production"]
    G4 --> G5["âš™ï¸ CrÃ©er ou mettre Ã  jour BuildConfig"]
    G5 --> G6["ðŸš€ Lancer le build sur le cluster"]
  end

%% Styles pour thÃ¨me sombre
  classDef pg       fill:#2c3e50,stroke:#3498db,stroke-width:2px;
  classDef quarkus  fill:#2c3e50,stroke:#2ecc71,stroke-width:2px;
  classDef front    fill:#2c3e50,stroke:#e67e22,stroke-width:2px;
  classDef keycloak fill:#2c3e50,stroke:#9b59b6,stroke-width:2px;
  classDef netpol   fill:#2c3e50,stroke:#e74c3c,stroke-width:2px;
  classDef ciback   fill:#2c3e50,stroke:#1abc9c,stroke-width:2px;
  classDef react    fill:#2c3e50,stroke:#c0392b,stroke-width:2px;

  class A2,A3,A4 pg
  class B2,B3,B4,B5,B6,B7,B8,B9,B10,B11,B12,B13 quarkus
  class C2,C3,C4,C5,C6,C7,C8 front
  class D2,D3,D4,D5,D6,D7,D8,D9 keycloak
  class E2,E3,E4,E5,E6 netpol
  class F2,F3 ciback
  class G2,G3,G4,G5,G6 react
